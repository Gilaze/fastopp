# FastAPI Migration Management Guide

This guide explains how to handle database migrations in your FastAPI application, equivalent to Django's `manage.py migrate` functionality.

## Overview

Your FastAPI project now includes a complete migration management system using **Alembic** (the standard migration tool for SQLAlchemy/SQLModel). This provides Django-like migration functionality with the syntax:

```bash
python oppman.py migrate [command]
```

## Quick Start

### 1. Initialize Migrations (First Time Only)

```bash
python oppman.py migrate init
```

This will:
- Initialize Alembic in your project
- Create `alembic/` directory and `alembic.ini`
- Configure the database URL for SQLite
- Set up model imports in `alembic/env.py`

### 2. Add New Models to `models.py`

Edit your `models.py` file to add new models:

```python
class Order(SQLModel, table=True):
    __tablename__ = "orders"
    
    id: Optional[uuid.UUID] = Field(default_factory=uuid.uuid4, primary_key=True)
    user_id: uuid.UUID = Field(foreign_key="users.id", nullable=False)
    total_amount: float = Field(nullable=False)
    status: str = Field(default="pending", max_length=20)
    created_at: datetime = Field(default_factory=datetime.utcnow)
```

### 3. Create a Migration

```bash
python oppman.py migrate create "Add Order model"
```

### 4. Apply the Migration

```bash
python oppman.py migrate upgrade
```

## Available Commands

### Basic Commands

```bash
# Initialize Alembic (first time only)
python oppman.py migrate init

# Create a new migration
python oppman.py migrate create "Description of changes"

# Apply all pending migrations
python oppman.py migrate upgrade

# Check current status
python oppman.py migrate current

# View migration history
python oppman.py migrate history
```

### Advanced Commands

```bash
# Downgrade to previous revision
python oppman.py migrate downgrade <revision>

# Show details of a migration
python oppman.py migrate show <revision>

# Mark database as up to date without running migrations
python oppman.py migrate stamp head

# Check if database is up to date
python oppman.py migrate check

# Update configuration files
python oppman.py migrate setup
```

## Workflow Examples

### Adding a New Table

1. **Add model to `models.py`**:
```python
class Category(SQLModel, table=True):
    __tablename__ = "categories"
    
    id: Optional[uuid.UUID] = Field(default_factory=uuid.uuid4, primary_key=True)
    name: str = Field(max_length=100, nullable=False)
    description: Optional[str] = Field(default=None)
```

2. **Create migration**:
```bash
python oppman.py migrate create "Add categories table"
```

3. **Apply migration**:
```bash
python oppman.py migrate upgrade
```

4. **Verify**:
```bash
python oppman.py migrate current
```

### Modifying Existing Table

1. **Modify model in `models.py`**:
```python
class User(SQLModel, table=True):
    __tablename__ = "users"
    
    id: Optional[uuid.UUID] = Field(default_factory=uuid.uuid4, primary_key=True)
    email: str = Field(unique=True, index=True, nullable=False)
    hashed_password: str = Field(nullable=False)
    is_active: bool = Field(default=True)
    is_superuser: bool = Field(default=False)
    # Add new field
    phone_number: Optional[str] = Field(default=None, max_length=20)
```

2. **Create migration**:
```bash
python oppman.py migrate create "Add phone number to users"
```

3. **Apply migration**:
```bash
python oppman.py migrate upgrade
```

## File Structure

```
fastapi_d/
├── models.py                    # Your SQLModel models
├── alembic/                     # Generated by migrate init
│   ├── versions/               # Migration files
│   ├── env.py                 # Alembic environment
│   └── script.py.mako         # Migration template
├── alembic.ini                # Alembic configuration
├── scripts/migrate/           # Migration management
│   ├── core.py               # Core functionality
│   ├── cli.py                # Command interface
│   └── README.md             # Detailed documentation
└── oppman.py                 # Main management script
```

## Comparison with Django

| Django Command | FastAPI Equivalent |
|----------------|-------------------|
| `python manage.py migrate` | `python oppman.py migrate upgrade` |
| `python manage.py makemigrations` | `python oppman.py migrate create "Description"` |
| `python manage.py showmigrations` | `python oppman.py migrate history` |
| `python manage.py migrate --plan` | `python oppman.py migrate check` |

## Troubleshooting

### Common Issues

1. **"Alembic not found"**
   ```bash
   uv add alembic
   ```

2. **"Alembic not initialized"**
   ```bash
   python oppman.py migrate init
   ```

3. **Migration conflicts**
   ```bash
   # Check current status
   python oppman.py migrate current
   
   # View history
   python oppman.py migrate history
   
   # Downgrade if needed
   python oppman.py migrate downgrade <revision>
   ```

4. **Configuration issues**
   ```bash
   python oppman.py migrate setup
   ```

### Database Issues

- **SQLite**: Uses `test.db` in project root
- **Backup**: `python oppman.py backup` before major changes
- **Reset**: `python oppman.py delete` to start fresh

## Best Practices

1. **Always create migrations** for model changes
2. **Use descriptive messages** when creating migrations
3. **Test migrations** in development before production
4. **Backup database** before applying migrations in production
5. **Review generated migrations** before applying them
6. **Keep migrations in version control**

## Integration with Existing Commands

The migration system integrates seamlessly with your existing `oppman.py` commands:

```bash
# Database management
python oppman.py db              # Initialize database
python oppman.py backup          # Backup database
python oppman.py delete          # Delete database

# Migration management
python oppman.py migrate init    # Initialize migrations
python oppman.py migrate create  # Create migration
python oppman.py migrate upgrade # Apply migrations

# Server management
python oppman.py runserver       # Start development server
python oppman.py production      # Start production server
```

## Migration Files

Migration files are stored in `alembic/versions/` and contain:
- **Upgrade operations**: Changes to apply to database
- **Downgrade operations**: How to reverse the changes
- **Metadata**: Migration information and dependencies

Example migration file:
```python
"""Add Order model

Revision ID: 8e825dae1884
Revises: 
Create Date: 2024-01-01 12:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
import sqlmodel

# revision identifiers
revision = '8e825dae1884'
down_revision = None
branch_labels = None
depends_on = None

def upgrade() -> None:
    # Upgrade operations
    op.create_table('users',
        sa.Column('id', sa.UUID(), nullable=False),
        sa.Column('email', sa.String(), nullable=False),
        sa.Column('hashed_password', sa.String(), nullable=False),
        sa.Column('is_active', sa.Boolean(), nullable=True),
        sa.Column('is_superuser', sa.Boolean(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )
    op.create_table('products',
        sa.Column('id', sa.UUID(), nullable=False),
        sa.Column('name', sa.String(length=100), nullable=False),
        sa.Column('description', sa.String(), nullable=True),
        sa.Column('price', sa.Float(), nullable=False),
        sa.Column('category', sa.String(length=50), nullable=True),
        sa.Column('in_stock', sa.Boolean(), nullable=True),
        sa.Column('created_at', sa.DateTime(), nullable=True),
        sa.Column('updated_at', sa.DateTime(), nullable=True),
        sa.PrimaryKeyConstraint('id')
    )

def downgrade() -> None:
    # Downgrade operations
    op.drop_table('products')
    op.drop_table('users')
```

## Next Steps

1. **Initialize migrations**: `python oppman.py migrate init`
2. **Add your models** to `models.py`
3. **Create migrations** as you develop: `python oppman.py migrate create "Description"`
4. **Apply migrations** to update your database: `python oppman.py migrate upgrade`
5. **Use in production** by running migrations before starting your server

This migration system provides the same functionality as Django's `manage.py migrate` but is tailored for your FastAPI + SQLModel setup. 